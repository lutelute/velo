name: Build & Release

on:
  workflow_call:
  workflow_dispatch:
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run test

  build:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            args: ""
          - platform: windows-latest
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - run: npm ci

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: "Velo v__VERSION__"
          releaseBody: "See the assets below to download for your platform."
          releaseDraft: false
          prerelease: false
          makeLatest: true
          updaterJsonKeepUniversal: true
          args: ${{ matrix.args }}

  build-macos:
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - run: npm ci

      - name: Check if Apple signing is configured
        id: signing-check
        run: |
          if [ -n "${{ secrets.APPLE_CERTIFICATE }}" ]; then
            echo "has_signing=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_signing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import Apple signing certificate
        if: steps.signing-check.outputs.has_signing == 'true'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build and release (signed + notarized)
        if: steps.signing-check.outputs.has_signing == 'true'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: "Velo v__VERSION__"
          releaseBody: "See the assets below to download for your platform."
          releaseDraft: false
          prerelease: false
          makeLatest: true
          updaterJsonKeepUniversal: true
          args: --target universal-apple-darwin

      - name: Build and release (unsigned)
        if: steps.signing-check.outputs.has_signing != 'true'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: "Velo v__VERSION__"
          releaseBody: |
            See the assets below to download for your platform.

            > **macOS users**: This build is unsigned. After downloading, run:
            > ```
            > xattr -cr /Applications/Velo.app
            > ```
            > Or right-click the app and select "Open" on first launch.
          releaseDraft: false
          prerelease: false
          makeLatest: true
          updaterJsonKeepUniversal: true
          args: --target universal-apple-darwin

      - name: Clean up keychain
        if: always() && steps.signing-check.outputs.has_signing == 'true'
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db

  update-homebrew:
    needs: build-macos
    if: always() && needs.build-macos.result == 'success'
    runs-on: macos-latest
    steps:
      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download DMG and compute SHA256
        id: sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Velo_${VERSION}_universal.dmg"

          echo "Downloading DMG from: ${DMG_URL}"
          curl -sL -o Velo.dmg "$DMG_URL"

          SHA256=$(shasum -a 256 Velo.dmg | awk '{print $1}')
          echo "SHA256: ${SHA256}"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: avihaymenahem/homebrew-velo
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-velo

      - name: Update cask definition
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA256="${{ steps.sha.outputs.sha256 }}"

          cat > homebrew-velo/Casks/velo.rb << CASK_EOF
          cask "velo" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/avihaymenahem/velo/releases/download/v#{version}/Velo_#{version}_universal.dmg",
                verified: "github.com/avihaymenahem/velo/"

            name "Velo"
            desc "Fast, beautiful desktop email client"
            homepage "https://github.com/avihaymenahem/velo"

            livecheck do
              url :url
              strategy :github_latest
            end

            depends_on macos: ">= :high_sierra"

            app "Velo.app"

            caveats <<~EOS
              If the app is not notarized, macOS may block it on first launch.
              To allow it, right-click Velo.app and select "Open", or run:
                xattr -cr /Applications/Velo.app
            EOS

            zap trash: [
              "~/Library/Application Support/com.velomail.app",
              "~/Library/Caches/com.velomail.app",
              "~/Library/Preferences/com.velomail.app.plist",
              "~/Library/Saved Application State/com.velomail.app.savedState",
              "~/Library/WebKit/com.velomail.app",
            ]
          end
          CASK_EOF

      - name: Commit and push to tap
        working-directory: homebrew-velo
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/velo.rb
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update velo to ${VERSION}"
          git push
